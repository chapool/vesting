# CPOP积分系统架构设计

## 概述

CPOP积分系统是一个基于以太坊账户抽象(EIP-4337)的内部积分生态系统，与现有的CPOT代币(HZToken.sol)形成互补，实现内外循环分离的双代币体系。

## 系统架构图

```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   APP用户界面    │    │   积分获取系统   │    │   链下商城系统   │    │   U卡充值系统   │
└─────────────────┘    └─────────────────┘    └─────────────────┘    └─────────────────┘
         │                       │                       │                       │
         └───────────────────────┼───────────────────────┼───────────────────────┘
                                 │                       │
         ┌─────────────────────────────────────────────┐ │
         │              CPOP核心层                    │ │
         │  ┌─────────────┐  ┌─────────────┐  ┌────────┐ │ │
         │  │CPOPToken   │  │AAWallet     │  │Paymaster│ │ │
         │  │积分代币      │  │账户抽象      │  │Gas代付  │ │ │
         │  └─────────────┘  └─────────────┘  └────────┘ │ │
         └─────────────────────────────────────────────┘ │
                                 │                       │
         ┌─────────────────────────────────────────────────────────┐ │
         │                    应用层合约                          │ │
         │  ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────────┐  │ │
         │  │Activity │  │Consumer │  │Recharge │  │Exchange     │  │ │
         │  │任务活动  │  │积分消费  │  │积分充值  │  │CPOT兑换     │  │ │
         │  └─────────┘  └─────────┘  └─────────┘  └─────────────┘  │ │
         └─────────────────────────────────────────────────────────┘ │
                                 │                       │
         ┌─────────────────────────────────────────────┐ │
         │              链下服务层                      │ │
         │  ┌─────────┐  ┌─────────┐  ┌─────────────┐  │ │
         │  │商品管理  │  │订单处理  │  │物流服务     │  │ │
         │  │服务     │  │服务     │  │             │  │ │
         │  └─────────┘  └─────────┘  └─────────────┘  │ │
         └─────────────────────────────────────────────┘ │
                                 │                       │
         ┌─────────────────────────────────────────────────────────────────────┐
         │                      金融服务层                                      │
         │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  │
         │  │U卡管理系统  │  │支付网关     │  │风控系统     │  │清算系统     │  │
         │  │(MasterCard) │  │服务        │  │             │  │             │  │
         │  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘  │
         └─────────────────────────────────────────────────────────────────────┘
                                 │
                    ┌─────────────────┐
                    │   CPOT代币      │
                    │  (HZToken.sol)  │
                    │   外部流通       │
                    └─────────────────┘
```

## 双代币体系设计

### CPOT代币 (现有HZToken.sol)
- **定位**: 外部流通代币
- **功能**: 完整的ERC20代币，支持交易所交易
- **特性**: 动态税收、黑名单管理、暂停等高级功能
- **流通**: 可自由转账，在DEX/CEX交易

### CPOP积分代币 (新设计)
- **定位**: 内部积分系统
- **功能**: 轻量化ERC20实现，专门为积分场景优化
- **特性**: 白名单转账限制、账户抽象集成、Gas代付支持
- **流通**: 仅在授权合约间转移，无法外部流通

## 核心设计原则

### 1. 内外分离
- CPOP专注于APP内积分经济
- CPOT面向外部价值交换
- 通过审核机制连接两个体系

### 2. 用户体验优先
- 账户抽象消除私钥管理复杂性
- Gas代付降低使用门槛
- 批量操作提升效率

### 3. 安全可控
- 多级权限管理
- 白名单转账限制
- 社交恢复机制
- 每日消费限额

### 4. 可扩展性
- 模块化合约设计
- 可升级合约架构
- 灵活的插件机制

## 技术特性

### 账户抽象 (EIP-4337)
- **社交恢复**: 守护者机制避免私钥丢失
- **批量操作**: 一次交易执行多个操作
- **消费限制**: 每日消费限额增强安全
- **Gas代付**: 用积分支付所有操作费用

### 积分经济系统
- **多源获取**: 签到、任务、推荐、活动等
- **等级系统**: 基于积分累计的用户成长
- **VIP机制**: 特权用户专享功能
- **商城消费**: 丰富的积分消费场景

### 安全机制
- **权限管理**: 基于角色的访问控制
- **转账限制**: 白名单合约间转移
- **暂停机制**: 紧急情况下的系统保护
- **审计跟踪**: 完整的操作日志

## 业务流程

### 积分获取流程

#### 免费获取
```
用户行为 → 触发奖励 → 验证规则 → 发放积分 → 更新等级/VIP状态
```

#### CPOT充值获取 (Recharge模块)
```
用户持有CPOT → 申请充值兑换 → 销毁CPOT代币 → 铸造CPOP积分 → 立即可用消费
```

**Recharge合约功能**:
- 接收CPOT代币充值
- 按1:1000比例转换为CPOP积分
- 执行CPOT销毁和CPOP铸造
- 记录充值历史和统计数据

### 积分消费流程

#### 线上消费
```
用户选择商品(链下) → 检查库存余额(混合) → 创建订单(链下) → 销毁积分(链上) → 履约发货(链下)
```

#### U卡充值消费
```
积分充值到U卡(链上) → 生成虚拟卡余额(金融服务) → 日常刷卡消费(传统支付) → 定期清算对账(链下)
```

### 兑换提现流程
```
申请兑换 → 销毁CPOP → 多级审核 → 铸造CPOT → 转账到用户钱包
```

## 与现有系统集成

### HZToken集成点
- **兑换桥接**: CPOP → CPOT的转换机制
- **审核系统**: 利用HZToken的权限管理
- **安全机制**: 复用黑名单、暂停等功能

### 部署策略
1. **阶段一**: 部署核心CPOP合约和CPOPConsumer
2. **阶段二**: 集成账户抽象功能和Gas代付
3. **阶段三**: 上线链下商城服务和活动系统
4. **阶段四**: 开启CPOT兑换功能

## 优势总结

### 技术优势
- 混合架构设计，大幅降低Gas消耗
- 账户抽象提升用户体验
- 链上链下分工明确，性能优化

### 业务优势
- 内部积分可控性强
- 外部代币价值明确
- 完整的用户成长体系

### 安全优势
- 多层安全防护
- 白名单转账限制
- 社交恢复机制

这个架构设计确保了CPOP积分系统的完整性、安全性和可扩展性，为用户提供优质的Web3积分体验。